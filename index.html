<!DOCTYPE html>
<html lang="ru">
<head> 
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>деньГа</title>

  <!-- Древнеславянский шрифт для заголовка -->
<link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">

<style>

/* Контейнер стопки */
.card-stack-btn {
  position: fixed;
  top: 600px;
  right: 20px;
  width: 100px;
  cursor: pointer;
  perspective: 800px;
  z-index: 999;
  display: none; /* По умолчанию скрыта */
}

.card-stack-btn.expanded {
  z-index: 1001;
}

/* Карта */
.card {
  position: absolute;
  width: 80px;
  height: 50px;
  border-radius: 8px;
  border: 1px solid #ccc;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: Arial, sans-serif;
  font-weight: bold;
  color: white;
  font-size: 18px;
  transform-origin: top center;
  transition: transform 0.4s cubic-bezier(0.25, 1.5, 0.5, 1), box-shadow 0.4s;
  user-select: none;
}

/* Цвета и подписи карт */
.card[data-bank="Сбер"] { background-color: #0f9d58; }
.card[data-bank="Яндекс"] { background-color: #ff6eb4; }
.card[data-bank="Тинькофф"] { background-color: #FFD700; color:#000; }
.card[data-bank="Альфа"] { background-color: #FF0000; }
.card[data-bank="ВТБ"] { background-color: #1E90FF; }
.card[data-bank="Халва"] { background-color: #A9A9A9; color:#000; }
.card[data-bank="Уралсиб"] { background-color: #800080; }
.card[data-bank="Другие"] { background-color: #000000; }

/* Положение карт в сложенном состоянии */
.card:nth-child(1) { transform: translate(0,0) rotate(-1deg); z-index:1; }
.card:nth-child(2) { transform: translate(4px,2px) rotate(1deg); z-index:2; }
.card:nth-child(3) { transform: translate(8px,4px) rotate(-1deg); z-index:3; }
.card:nth-child(4) { transform: translate(12px,6px) rotate(1deg); z-index:4; }
.card:nth-child(5) { transform: translate(16px,8px) rotate(-1deg); z-index:5; }
.card:nth-child(6) { transform: translate(20px,10px) rotate(1deg); z-index:6; }
.card:nth-child(7) { transform: translate(24px,12px) rotate(-1deg); z-index:7; }
.card:nth-child(8) { transform: translate(28px,14px) rotate(1deg); z-index:8; }

.card .bank-buttons {
  position: absolute;
  left: 110%;       /* справа от карточки */
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 5px;
  opacity: 0;              /* полностью невидимы */
  pointer-events: none;     /* нельзя кликнуть */
  transition: opacity 0.3s;
}

.card-stack-btn.expanded .card .bank-buttons {
  opacity: 1;               /* станут видимыми при раскрытии */
  pointer-events: auto;     /* кликабельны */
}

.bank-buttons button {
  background: none;       /* без фона */
  border: none;           /* без рамки */
  color: transparent;     /* текст невидим */
  opacity: 0;             /* полная прозрачность */
  width: 40px;            /* задаём размеры кнопки */
  height: 40px;
  cursor: pointer;        /* курсор как у обычной кнопки */
  transition: opacity 0.3s, color 0.3s; /* плавное появление */
}

/* ИСПРАВЛЕНИЕ: Кнопки становятся видимыми в expanded */
.card-stack-btn.expanded .card .bank-buttons button {
  opacity: 1;
  color: #333; /* или inherit, чтобы текст был виден */
}

/* Положение карт при раскрытии */
.card-stack-btn.expanded .card:nth-child(1) { transform: translate(0,0px) rotate(0deg) scale(1.05); }
.card-stack-btn.expanded .card:nth-child(2) { transform: translate(0,-70px) rotate(-5deg) scale(1.05); }
.card-stack-btn.expanded .card:nth-child(3) { transform: translate(0,-140px) rotate(3deg) scale(1.05); }
.card-stack-btn.expanded .card:nth-child(4) { transform: translate(0,-210px) rotate(-3deg) scale(1.05); }
.card-stack-btn.expanded .card:nth-child(5) { transform: translate(0,-280px) rotate(2deg) scale(1.05); }
.card-stack-btn.expanded .card:nth-child(6) { transform: translate(0,-350px) rotate(-2deg) scale(1.05); }
.card-stack-btn.expanded .card:nth-child(7) { transform: translate(0,-420px) rotate(4deg) scale(1.05); }
.card-stack-btn.expanded .card:nth-child(8) { transform: translate(0,-490px) rotate(-4deg) scale(1.05); }

/* Оверлей, который блокирует экран */
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.5);
  display: none;
  z-index: 1000;
}

html, body {
    overflow-x: hidden;
    touch-action: pan-y;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background-color: #f2f2f2;

    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}


header {
  background: linear-gradient(145deg, #4CAF50, #2E7D32);
  color: white;
  font-weight: bold;
  text-align: left;
  font-size: 32px;
  padding: 30px 40px;
  margin: 15px;
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25),
              inset 0 2px 6px rgba(255,255,255,0.3);
  position: relative;
  overflow: hidden;
  font-family: 'MedievalSharp', cursive;
}

/* Контейнер блеска */
.shine-container {
  position: absolute;
  top: 28px;      /* можно менять на 50px, 80px — опускаем вниз */
  left: 11%;       
  width: 78%;     
  height: 163px;  /* по высоте шапки или чуть больше */
  overflow: hidden; 
  pointer-events: none;
}

/* Сама блестящая полоска */
.shine-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: -30%;            /* стартовая позиция полоски внутри контейнера */
  width: 40%;
  height: 100%;
  background: linear-gradient(
    120deg,
    rgba(255,255,255,0.1) 0%,
    rgba(255,255,255,0.4) 30%,
    rgba(255,255,255,0.1) 60%
  );
  transform: skewX(-25deg);
  animation: shine 10s infinite;
}

@keyframes shine {
  0% {
    left: -120%;   /* старт за пределами контейнера */
    opacity: 0;    /* полностью прозрачная */
  }
  5% {
    opacity: 1;    /* появляется плавно */
  }
  70% {
    left: 100%;    /* движение до конца */
    opacity: 0.1;
  }
  100% {
    left: 100%;    /* полностью за границей */
    opacity: 0;    /* исчезает */
  }
}

/* Имитация чипа */
header::after {
  content: '';
  position: absolute;
  top: 50px;
  right: 50px;
  width: 40px;
  height: 28px;
  background: linear-gradient(135deg, #d4af37, #f5e29f);
  border-radius: 4px;
  box-shadow: inset 0 0 3px rgba(0,0,0,0.3);
}

/* Название в «карточном» стиле */
.header-box {
  display: inline-block;
  background: transparent;
  color: #fff;
  font-size: 36px;
  letter-spacing: 1px;
  text-shadow: 0 0 8px rgba(0,0,0,0.4);
}

nav {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
}

nav button {
    padding: 12px 22px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 10px;
    border: 2px solid #0b5ea8;
    background: white;
    color: #4CAF50;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    z-index: 1; 
}

nav button:hover {
    background: linear-gradient(135deg, #A8E6A2, #45A049);
    color: white;
}

button:hover {
    background-color: #0b7dda;
}

@keyframes spring {
    0% { transform: scale(1); }
    10% { transform: scale(0.7); }
    20% { transform: scale(1.3); }
    30% { transform: scale(0.8); }
    40% { transform: scale(1.2); }
    50% { transform: scale(0.9); }
    60% { transform: scale(1.1); }
    70% { transform: scale(0.95); }
    80% { transform: scale(1.05); }
    90% { transform: scale(0.99); }
    100% { transform: scale(1); }
}

.springing {
    animation: spring 0.95s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

main {
    padding: 20px;
    text-align: center;
}

section {
    display: none;
}

#categoriesList {
    display: block;
    margin-top: 15px;
}

#categoriesList button {
    display: block;
    width: 65%; /* было 85% — теперь короче, визуально компактнее */
    margin: 10px 0;
    padding: 16px 20px; /* вернули как было, чтобы не казались меньше */
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    position: relative;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: linear-gradient(135deg, #5A7DE1, #A0D4FA);
    color: white;
    border: 2px solid #0b5ea8;
    text-align: left;
    margin-left: 20px; /* лёгкий отступ от края */
}

#sparkCanvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 1000;
}

.action-modal {
    position: fixed;
    background: rgba(65, 105, 225, 1);
    border-radius: 20px;
    box-shadow: 0 7px 19px rgba(0,0,0,0.25);
    padding: 25px;
    display: flex;
    gap: 10px;
    flex-direction: column;
    animation: fadeIn 0.1s ease-out;
    z-index: 9999;
}

.action-modal button {
    background: linear-gradient(135deg, rgba(244,67,54,1), rgba(255,153,153,1));
    color: white;
    font-weight: bold;
    padding: 20px;
    border-radius: 38px;
    transition: background 0.2s;
}

.action-modal button.rename {
    background: #2196F3;
}

.action-modal button:hover {
    opacity: 0.85;
}

@keyframes fadeIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.rename-container {
    margin-top: 5px;
    display: flex;
    justify-content: center;
}

.rename-container input {
    padding: 5px;
    margin-right: 5px;
    width: 60%;
    max-width: 200px;
}

.rename-container button {
    padding: 5px 10px;
}

.placeholder {
    border: 2px dashed #2196F3;
    margin-bottom: 10px;
    height: 40px;
}

.dragging {
    opacity: 0.7;
    position: absolute;
    z-index: 1000;
    pointer-events: none;
}

#statsCategories {
    margin-top: 10px;
    text-align: left;
    max-width: 600px;
    margin-inline: auto;
}

.stat-item {
    background: #ffffff;
    border: 2px solid #4CAF50;
    border-radius: 10px;
    padding: 10px 14px;
    margin-bottom: 8px;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#settingsSubmenu {
    display: none;
    margin-top: 15px;
    padding: 10px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

#settingsCategories button {
    display: block;
    width: 100%;
    margin-bottom: 8px;
    padding: 8px 12px;
    background: #2196F3;
    color: #fff;
    border: none;
    border-radius: 6px;
    text-align: left;
    cursor: pointer;
    transition: background 0.3s;
}

#settingsCategories button:hover {
    background: #0b7dda;
}

#settings button {
    display: block;
    width: 100%;
    margin-bottom: 10px;
    padding: 10px 15px;
    background: linear-gradient(135deg, #5A7DE1, #A0D4FA);
    color: #fff;
    border: none;
    border-radius: 6px;
    text-align: left;
    cursor: pointer;
    transition: background 0.3s;
}

#settings button:hover {
    background: #0b7dda;
}

.totals-box {
    background: #4CAF50;      /* зелёный фон */
    border-radius: 12px;      /* округлённые углы */
    padding: 15px;            /* внутренний отступ */
    color: white;             /* белый текст */
    font-weight: bold;        /* жирный шрифт */
    text-align: center;       /* выравнивание по центру */
    margin-top: 15px;         /* отступ сверху */
    font-size: 18px;          /* чуть крупнее текст */
}


#totalsContainer {
    background: #4CAF50;
    border-radius: 12px;
    padding: 20px;
    color: white;
    font-weight: bold;
    text-align: center;
    margin-top: 20px;
}

#totalsContainer h3 {
    margin-top: 0;
    font-size: 20px;
}

#totalsContainer p {
    margin: 8px 0;
    font-size: 18px;
}

.app-container {
    margin-left: auto;
    margin-right: auto;
    padding-left: 15px;
    padding-right: 15px;
    max-width: 1200px;
    border-left: 5px solid #0b5ea8;
    border-right: 5px solid #0b5ea8;
    box-sizing: border-box;
    background-color: #f2f2f2;
}

@media (max-width: 600px) {
    .app-container {
        padding-left: 8px;
        padding-right: 8px;
        border-left: 2px solid #0b5ea8;
        border-right: 2px solid #0b5ea8;
    }


#clock {
    opacity: 0; /* полностью прозрачный элемент */
    background: transparent !important;
    box-shadow: none !important;
    color: transparent !important;
}

/* === iOS тумблер === */
.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 26px;
  vertical-align: middle;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .3s;
  border-radius: 34px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .3s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #4CAF50;
}
input:checked + .slider:before {
  transform: translateX(20px);
}
}
.limit-badge {
    display: inline-block;
    padding: 4px 10px;
    margin-left: 8px;
    background: #f0f0f0;
    border-radius: 12px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.1);
    font-size: 14px;
    font-weight: bold;
    color: #4CAF50;
    min-width: 50px;
    text-align: center;
    transition: background 0.3s, transform 0.2s;
}

.limit-badge:hover {
    background: #e0ffe0;
    transform: scale(1.05);
}

.limit-badge {
    display: inline-block;
    padding: 4px 10px;
    margin-left: 8px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
    min-width: 50px;
    text-align: center;
    transition: background 0.3s, transform 0.2s;
    background: #f0f0f0; /* серый по умолчанию */
    color: #4CAF50;
}

.limit-badge.active {
    background: #4CAF50;
    color: white;
}
.settings-row {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 8px;
}

.settings-row .name {
    font-weight: bold;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1; /* занимает всё доступное пространство слева */
}

.limit-badge {
    margin: 0 10px; /* небольшой отступ слева и справа */
    min-width: 60px;
    text-align: center;
}

.settings-row .switch {
    flex-shrink: 0; /* тумблер не сжимается */
}
#background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: white;
  z-index: -1; /* делает слой под всем остальным */
}
/* Фон убираем у всего интерфейса */
body, 
.app-container, 
header, 
nav, 
main, 
section, 
#statsCategories, 
#settingsSubmenu, 
#adminSubmenu {
  background: transparent !important;
  box-shadow: none !important;
}

/* Кнопки и панели тоже делаем «воздушными» */
button {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(5px);
  border: 1px solid rgba(255,255,255,0.3);
}

/* Модальные окна тоже прозрачные */
.action-modal {
  background: rgba(255,255,255,0.15) !important;
  backdrop-filter: blur(10px);
  box-shadow: none !important;
}

/* Фон под всем остальным — остаётся управляемым */
#background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: white; /* можно заменить на картинку или сделать прозрачным */
  z-index: -1;
}


#header-layer header {
  background: linear-gradient(135deg, #E6FFE6, #45A049);
  color: #0b5ea8; /* 🔵 синий цвет текста */
  font-weight: bold;
  text-align: center;
  font-size: 42px;
  padding: 25px;
  border-radius: 0 0 12px 12px;
  font-family: 'MedievalSharp', cursive;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}
nav {
  margin-top: 50px; /* регулируй по высоте шапки */
}
#header-layer {
  position: relative;
  width: 100%;
  z-index: -2;
  overflow: visible; /* теперь блеск не будет обрезаться */
}


.header-box {
  display: inline-block;
  background: #4CAF50;
  color: white;
  padding: 60px 93px;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.8);
  box-shadow: 0 0 10px #4CAF50, 0 0 20px rgba(11,94,168,0.6);
  font-family: 'MedievalSharp', cursive;
  font-size: 34px;
}
#scrollLayer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 50px; /* максимальная высота плашки */
    pointer-events: none; /* клики проходят сквозь слой */
    z-index: 1000000; /* выше всех элементов */
}

#scrollBar {
    position: fixed;       /* фиксируем относительно окна */
    top: 0;                /* растёт вниз от верха */
    left: 0;
    width: 100%;
    height: 0;             /* стартовая высота */
    background: linear-gradient(180deg, #4CAF50, #81C784);
    z-index: -1;       /* поверх всего */
    pointer-events: none;  /* клики проходят сквозь */
    transition: height 0.1s ease-out;
}
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.5); /* полупрозрачный черный */
  display: none; /* скрыт по умолчанию */
  z-index: 1000; /* выше всего остального */
}

/* Стили для модалки истории */
.history-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  z-index: 1001;
  max-width: 90vw;
  max-height: 80vh;
  overflow: auto;
}

.history-modal table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 15px;
}

.history-modal th,
.history-modal td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

.history-modal th {
  background-color: #f2f2f2;
  font-weight: bold;
}

.history-modal button {
  padding: 10px 20px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  width: 100%;
}

.history-modal button:hover {
  background: #45a049;
}
</style>
</head>
<body>
<div id="overlay"></div>

<div class="card-stack-btn" id="cardStack">
  <div class="card" data-bank="Сбер"><span>Сбер</span><div class="bank-buttons"><button data-bank="Сбер">Сбер</button></div></div>
  <div class="card" data-bank="Яндекс"><span>Я</span><div class="bank-buttons"><button data-bank="Яндекс">Яндекс</button></div></div>
  <div class="card" data-bank="Тинькофф"><span>Т</span><div class="bank-buttons"><button data-bank="Тинькофф">Тинькофф</button></div></div>
  <div class="card" data-bank="Альфа"><span>А</span><div class="bank-buttons"><button data-bank="Альфа">Альфа</button></div></div>
  <div class="card" data-bank="ВТБ"><span>ВТБ</span><div class="bank-buttons"><button data-bank="ВТБ">ВТБ</button></div></div>
  <div class="card" data-bank="Халва"><span>Халва</span><div class="bank-buttons"><button data-bank="Халва">Халва</button></div></div>
  <div class="card" data-bank="Уралсиб"><span>Урал</span><div class="bank-buttons"><button data-bank="Уралсиб">Уралсиб</button></div></div>
  <div class="card" data-bank="Другие"><span>Другие</span><div class="bank-buttons"><button data-bank="Другие">Другие</button></div></div>
</div>
  <!-- Отдельный слой под шапку -->
<div id="header-layer">
  <header>
    <span class="header-box">дѢньга</span>
  </header>

  <!-- Контейнер блеска теперь вне header -->
  <div class="shine-container"></div>
</div>

<div id="scrollBar"></div>

  <div class="app-container">
  <nav>
    <button onclick="spring(this); showSection('expenses')">Расходы</button>
    <button onclick="spring(this); showSection('stats')">Статистика</button>
    <button onclick="spring(this); showSection('settings')">Настройки</button>
  </nav>

  <main>
<section id="expenses">
  <h2>Расходы</h2>
  <p></p>

  <button onclick="addCategory(this)">Добавить категорию</button>
  <div id="newCategoryContainer"></div>
  <div id="categoriesList"></div>
</section>

<section id="stats">
  <h2>Статистика</h2>
  <p></p>

  <h3>Категории</h3>
  <div id="statsCategories"></div>

<h3>Диаграмма расходов</h3>
<canvas id="statsChart" width="400" height="400"></canvas>

<h3>Итого расходов</h3>
<div id="totalExpenses" class="totals-box"></div>

<h3>Итоговые лимиты</h3>
<div id="totalLimits" class="totals-box"></div>

<button onclick="spring(this); showHistory()">История расходов</button>

</section>

<section id="settings">
  <h2>Настройки</h2>
  <p></p>

  <button onclick="toggleSubmenu()">лимиты</button>

  <div id="settingsSubmenu" style="display: none;">
    <h3>Категории расходов</h3>
    <div id="settingsCategories"></div>
  </div>

  <button onclick="toggleAdminSubmenu()">управление данными</button>

  <div id="adminSubmenu" style="display: none; margin-top: 15px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
    <h3>Управление данными</h3>
    <button onclick="if(confirm('Ты увере, что хочешь сделать с лимитами то, что хочешь?')) clearLimits();">Удалить все лимиты</button>
    <button onclick="if(confirm('Ты уверен, что хочешь сделать с расходами то, что хочешь?')) clearExpenses();">Удалить все расходы</button>
  </div>
</section>
</main>

<canvas id="sparkCanvas"></canvas>

<script>

// Глобальные переменные для карт (чтобы были доступны в других функциях)
let cards = [];
const stack = document.getElementById('cardStack');
const overlay = document.getElementById('overlay');
const cardStack = document.getElementById('cardStack');

// Инициализация карт после загрузки DOM
function initCards() {
    if (!stack || !overlay) {
        console.error('Элементы stack или overlay не найдены');
        return;
    }

    // Геттер для карточек (чтобы всегда актуальный список)
    const getCards = () => Array.from(stack.querySelectorAll('.card'));
    cards = getCards(); // Инициализация

    function moveCardToTop(bankName) {
        const card = cards.find(c => c.dataset.bank === bankName);
        if (!card) return;
        
        stack.appendChild(card);
        // Обновляем массив эффективно, без повторного парсинга DOM
        cards = [...cards.filter(c => c !== card), card];
        // Сохраняем выбранный банк в localStorage
        localStorage.setItem('selectedBank', bankName);
        // Переинициализируем слушатели после перемещения
        initCardListeners();
    }

    function toggleStack() {
        stack.classList.toggle('expanded');
        overlay.style.display = stack.classList.contains('expanded') ? 'block' : 'none';
    }

    stack.addEventListener('click', e => {
        // Проверяем ближайшую кнопку, чтобы не пропустить вложенные элементы
        if (e.target.closest('button')) return;
        toggleStack();
    });

    overlay.addEventListener('click', () => {
        stack.classList.remove('expanded');
        overlay.style.display = 'none';
    });

    // Обработчики для кнопок банков (используем data-bank для надёжности)
    stack.querySelectorAll('.bank-buttons button').forEach(btn => {
        btn.addEventListener('click', e => {
            e.stopPropagation();
            const bankName = btn.dataset.bank || btn.textContent.trim();
            moveCardToTop(bankName);
            stack.classList.remove('expanded');
            overlay.style.display = 'none';
        });
    });

    // Обработчики для кликов по карточкам
    function initCardListeners() {
        getCards().forEach(card => {
            // Удаляем старые слушатели, чтобы избежать дублирования
            card.removeEventListener('click', handleCardClick);
            card.addEventListener('click', handleCardClick);
        });
    }

    function handleCardClick(e) {
        if (!stack.classList.contains('expanded')) return;
        e.stopPropagation();
        moveCardToTop(this.dataset.bank);
        stack.classList.remove('expanded');
        overlay.style.display = 'none';
    }

    initCardListeners(); // Инициализация
}

// Функции навигации и анимации
function showSection(id) {
    const sections = document.querySelectorAll('main section');
    sections.forEach(sec => sec.style.display = 'none');
    const targetSection = document.getElementById(id);
    if (targetSection) {
        targetSection.style.display = 'block';
    } else {
        console.warn(`Секция с id "${id}" не найдена`);
    }

    // Управление видимостью стопки карт
    if (id === 'expenses') {
        cardStack.style.display = 'block';
    } else {
        cardStack.style.display = 'none';
        // Закрываем стопку, если она открыта
        if (cardStack.classList.contains('expanded')) {
            cardStack.classList.remove('expanded');
            overlay.style.display = 'none';
        }
    }
}

function spring(button) {
    if (!button) return;
    button.classList.remove('springing');
    void button.offsetWidth; // Триггер reflow для анимации
    button.classList.add('springing');
    if ('vibrate' in navigator) {
        navigator.vibrate(50);
    }
}

/* ================== LocalStorage ================== */
function saveCategory(name) {
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    categories.push({name: name, amount: 0, limit: 0, lastUpdate: null});
    localStorage.setItem('categories', JSON.stringify(categories));
}

function updateCategory(index, newName) {
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    categories[index].name = newName.length > 15 ? newName.slice(0,15) : newName;
    localStorage.setItem('categories', JSON.stringify(categories));
}

function deleteCategory(index) {
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    categories.splice(index, 1);
    localStorage.setItem('categories', JSON.stringify(categories));
}

function addCategory(button) {
    const container = document.getElementById('newCategoryContainer');
    if (!container) {
        console.warn('Контейнер newCategoryContainer не найден');
        return;
    }
    
    container.innerHTML = ''; // Очистка

    // Создаём форму для ввода новой категории
    const form = document.createElement('form');
    form.style.display = 'flex';
    form.style.gap = '10px';
    form.style.marginTop = '10px';

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Название новой категории';
    input.id = 'newCategoryInput';
    input.required = true;
    input.style.flex = '1';
    input.style.padding = '8px';
    input.maxLength = 15;

    const saveBtn = document.createElement('button');
    saveBtn.type = 'submit';
    saveBtn.textContent = 'Сохранить';
    saveBtn.style.padding = '8px 16px';
    saveBtn.onclick = (e) => {
        e.preventDefault();
        const categoryName = input.value.trim();
        if (categoryName) {
            saveCategory(categoryName);
            renderCategories();
            container.innerHTML = ''; // Скрыть форму
        } else {
            alert('Введите название категории');
        }
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.textContent = 'Отмена';
    cancelBtn.style.padding = '8px 16px';
    cancelBtn.style.backgroundColor = '#f0f0f0';
    cancelBtn.onclick = () => {
        container.innerHTML = '';
    };

    form.appendChild(input);
    form.appendChild(saveBtn);
    form.appendChild(cancelBtn);
    container.appendChild(form);

    input.focus(); // Фокус на инпут для удобства
}

/* ================== Рендер категорий с drag & drop ================== */
function renderCategories() {
    const list = document.getElementById('categoriesList');
    const statsList = document.getElementById('statsCategories');
    const settingsList = document.getElementById('settingsCategories'); // новый список (подменю)

    list.innerHTML = '';
    if (statsList) statsList.innerHTML = '';
    if (settingsList) settingsList.innerHTML = ''; // чистим подменю перед перерисовкой

    let categories = JSON.parse(localStorage.getItem('categories')) || [];

    categories.forEach((cat, idx) => {
        const catBtn = document.createElement('button');
        let displayName = cat.name.length > 15 ? cat.name.slice(0,15) : cat.name;

        catBtn.textContent = displayName;

        let pressTimer;
        let isDragging = false;
        let startY, currentIndex = idx;

        catBtn.addEventListener('mousedown', startPress);
        catBtn.addEventListener('touchstart', startPress, { passive: false });

        catBtn.addEventListener('mouseup', cancelPress);
        catBtn.addEventListener('mouseleave', cancelPress);
        catBtn.addEventListener('touchend', cancelPress);

        function startPress(e) {
            // 🚫 Без "ЯСТРЕБА" перетаскивание запрещено
            if (!dragEnabled) {
                pressTimer = setTimeout(() => {
                    showActionModal(catBtn, currentIndex);
                }, 1); // обычное долгое нажатие
                return;
            }

            if (e.type === 'touchstart') e.preventDefault();
            startY = e.clientY || (e.touches && e.touches[0].clientY);
            isDragging = false;

            pressTimer = setTimeout(() => {
                if (!isDragging) showActionModal(catBtn, currentIndex);
            }, 10);

            function onMove(ev) {
                const moveY = ev.clientY || (ev.touches && ev.touches[0].clientY);
                if (!isDragging && Math.abs(moveY - startY) > 5) {
                    isDragging = true;
                    clearTimeout(pressTimer);
                    removeActionModal();
                    catBtn.classList.add('dragging');
                }
                if (isDragging) {
                    const buttons = Array.from(list.children).filter(b => b.tagName === 'BUTTON');
                    let overIndex = buttons.findIndex(b => {
                        const rect = b.getBoundingClientRect();
                        return moveY > rect.top && moveY < rect.bottom;
                    });
                    if (overIndex !== -1 && overIndex !== currentIndex) {
                        list.insertBefore(catBtn, (overIndex > currentIndex ? buttons[overIndex].nextSibling : buttons[overIndex]));
                        let moved = categories.splice(currentIndex, 1)[0];
                        categories.splice(overIndex, 0, moved);
                        currentIndex = overIndex;
                        localStorage.setItem('categories', JSON.stringify(categories));
                    }
                }
            }

            function endDrag() {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', endDrag);
                document.removeEventListener('touchend', endDrag);
                catBtn.classList.remove('dragging');
                clearTimeout(pressTimer);
            }

            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function cancelPress() {
            clearTimeout(pressTimer);
        }

        list.appendChild(catBtn);

        if (statsList) {
            const statItem = document.createElement('div');
            statItem.className = 'stat-item';
            statItem.style.display = "flex";
            statItem.style.justifyContent = "space-between";
            statItem.style.alignItems = "center";

            // Левая часть (потрачено)
            const left = document.createElement('span');
            left.textContent = `${cat.name}: ${cat.amount.toFixed(2)} ₽`;

            statItem.appendChild(left);

            // Правая часть (остаток)
            if (cat.limit && cat.limit > 0) {
                const right = document.createElement('span');
                let remaining = cat.limit - cat.amount;

                right.textContent = `Остаток: ${remaining.toFixed(2)} ₽`;

                if (remaining < 0) {
                    right.style.color = "red"; // подсветка при перерасходе
                }

                statItem.appendChild(right);
            }

            statsList.appendChild(statItem);
        }

        // === Кнопка для настроек (выравнивание лимита по правому краю) ===
        if (settingsList) {
            const row = document.createElement('div');
            row.className = 'settings-row';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'name';
            nameSpan.textContent = cat.name;

            row.appendChild(nameSpan);

            if (cat.limit && cat.limit > 0) {
                const limitBadge = document.createElement('span');
                limitBadge.className = 'limit-badge';
                limitBadge.textContent = `${cat.limit} ₽`;
                if (cat.limitEnabled) limitBadge.classList.add('active');
                row.appendChild(limitBadge);
            }

            const label = document.createElement('label');
            label.className = "switch";
            const input = document.createElement('input');
            input.type = "checkbox";
            input.checked = cat.limitEnabled ?? (cat.limit && cat.limit > 0);
            const slider = document.createElement('span');
            slider.className = "slider";
            label.appendChild(input);
            label.appendChild(slider);
            row.appendChild(label);

            input.addEventListener('change', () => {
                let categories = JSON.parse(localStorage.getItem('categories')) || [];
                categories[idx].limitEnabled = input.checked;
                localStorage.setItem('categories', JSON.stringify(categories));

                const limitBadge = row.querySelector('.limit-badge');
                if (limitBadge) {
                    if (input.checked) limitBadge.classList.add('active');
                    else limitBadge.classList.remove('active');
                }

                calculateWeeklyExpenses();
            });

            row.addEventListener('click', (e) => {
                if (e.target.tagName.toLowerCase() === 'input' || e.target.classList.contains('slider')) return;
                let categories = JSON.parse(localStorage.getItem('categories')) || [];
                let value = prompt(`Введите лимит для категории "${cat.name}"`, cat.limit || 0);
                if (value !== null && !isNaN(value)) {
                    categories[idx].limit = parseFloat(value);
                    localStorage.setItem('categories', JSON.stringify(categories));
                    renderCategories();
                }
            });

            settingsList.appendChild(row);
        }
    });

    // отрисовываем круговую диаграмму
    renderChart(categories);

    // ================== Итоговые суммы ==================
    let total = categories.reduce((sum, c) => sum + c.amount, 0);
    let totalLimits = categories.reduce((sum, c) => sum + (c.limit || 0), 0);

    const totalContainer = document.getElementById('totalExpenses');
    if (totalContainer) {
        totalContainer.innerHTML = `<p>Всего расходов: ${total.toFixed(2)} ₽</p>
                                    <p id="weeklyExpenses">Еженедельные расходы: 0 ₽</p>`;
    }

    const weeklyElem = document.getElementById('weeklyExpenses');
    if (weeklyElem) {
        let weeklyTotal = parseFloat(localStorage.getItem('weeklyTotal')) || 0;
        weeklyElem.textContent = `Еженедельные расходы: ${weeklyTotal.toFixed(2)} ₽`;
    }

    const totalLimitsContainer = document.getElementById('totalLimits');
    if (totalLimitsContainer) {
        totalLimitsContainer.textContent = `Всего лимитов: ${totalLimits.toFixed(2)} ₽`;
    }
}

/* =================== Диаграмма =================== */
let chartInstance = null;

function renderChart(categories) {
    const ctx = document.getElementById('statsChart');
    if (!ctx) return;

    if (chartInstance) {
        chartInstance.destroy();
    }

    const labels = categories.map(c => c.name);
    const data = categories.map(c => c.amount);

    chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FF6384','#36A2EB','#FFCE56',
                    '#4CAF50','#FF9800','#9C27B0',
                    '#00BCD4','#E91E63'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: {
                    display: true,
                    text: 'Распределение расходов по категориям'
                }
            }
        }
    });
}

/* =================== Модалки =================== */
let currentModal = null;
let outsideClickHandler = null;
let dragEnabled = false;
let hawkMode = false;

function showActionModal(button, index) {
    removeActionModal();

    const modal = document.createElement('div');
    modal.className = 'action-modal';

    Object.assign(modal.style, {
        position: 'fixed',
        background: '#fff',
        padding: '20px',
        border: '1px solid #000',
        borderRadius: '8px',
        boxShadow: '0 2px 10px rgba(0,0,0,0.3)',
        display: 'flex',
        flexDirection: 'column',
        gap: '10px',
        zIndex: 9999,
        opacity: 0,
        transition: 'opacity 0.2s ease'
    });

    const renameBtn = document.createElement('button');
    renameBtn.textContent = 'Переименовать';
    renameBtn.onclick = (e) => {
        e.stopPropagation();
        removeActionModal();
        showRenameField(button, index);
    };

    const addExpenseBtn = document.createElement('button');
    addExpenseBtn.textContent = 'Внести расход';
    addExpenseBtn.onclick = (e) => {
        e.stopPropagation();
        removeActionModal();

        let categories = JSON.parse(localStorage.getItem('categories'));
        const category = categories[index];

        let amount = prompt(`Введите сумму расхода для категории "${category.name}"`, '0');
        if (amount !== null && !isNaN(amount)) {
            amount = parseFloat(amount);

            // Получаем текущий банк
            const bank = localStorage.getItem('selectedBank') || 'Неизвестно';

            // Текущая дата и день недели
            const now = new Date();
            const dateStr = now.toLocaleDateString('ru-RU');
            const days = ['Воскресенье','Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];
            const dayOfWeek = days[now.getDay()];
            const dateISO = now.toISOString();

            // Добавляем в историю расходов
            let history = JSON.parse(localStorage.getItem('expensesHistory')) || [];
            history.push({
                bank: bank,
                dateStr: dateStr,
                dayOfWeek: dayOfWeek,
                amount: amount,
                category: category.name,
                dateISO: dateISO
            });
            localStorage.setItem('expensesHistory', JSON.stringify(history));

            // === Обновляем категорию ===
            category.amount += amount;
            category.lastUpdate = dateISO;
            categories[index] = category;
            localStorage.setItem('categories', JSON.stringify(categories));

            // === Добавляем к еженедельным расходам, если категория включена ===
            // === пересчитываем weeklyTotal через функцию, чтобы учитывались тумблеры ===
            calculateWeeklyExpenses();

            renderCategories(); // обновляем интерфейс
        } else {
            alert('Некорректная сумма');
        }
    };

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Удалить';
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteCategory(index);
        removeActionModal();
        renderCategories();
    };

    modal.appendChild(renameBtn);
    modal.appendChild(addExpenseBtn);
    modal.appendChild(deleteBtn);

    // === Новая кнопка "ЯСТРЕБ" ===
    const hawkBtn = document.createElement('button');
    hawkBtn.textContent = 'настроить 🦅';
    hawkBtn.style.background = 'linear-gradient(135deg, #5A7DE1, #A0D4FA)';
    hawkBtn.style.color = 'white';
    hawkBtn.style.fontWeight = 'bold';
    hawkBtn.style.borderRadius = '38px';
    hawkBtn.onclick = (e) => {
        e.stopPropagation();
        removeActionModal(); 
        dragEnabled = true; 
        hawkMode = true;

        // Создаём блокирующий слой поверх всего
        const blocker = document.createElement('div');
        blocker.id = 'hawkBlocker';
        Object.assign(blocker.style, {
            position: 'fixed',
            top: 0,
            left: 0,
            width: '100%',
            height: '100%',
            background: 'rgba(0,0,0,0.2)',
            zIndex: 99999,
            cursor: 'not-allowed',
            pointerEvents: 'none'
        });
        document.body.appendChild(blocker);

        // === Кнопка "ОК" ===
        const exitBtn = document.createElement('button');
        exitBtn.id = 'exitHawkBtn';
        exitBtn.textContent = 'ОК';
        Object.assign(exitBtn.style, {
            position: 'fixed',
            bottom: '20px',
            right: '20px',
            padding: '15px 25px',
            fontSize: '18px',
            borderRadius: '12px',
            background: 'linear-gradient(135deg, #4CAF50, #81C784)',
            color: 'white',
            fontWeight: 'bold',
            zIndex: 100000
        });
        exitBtn.onclick = () => {
            document.getElementById('hawkBlocker')?.remove();
            exitBtn.remove();
            hawkMode = false;
            dragEnabled = false;
            alert('🦅 ЯСТРЕБ ушёл отдыхать.');
        };
        document.body.appendChild(exitBtn);

        alert('🦅 ЯСТРЕБ взлетел! Интерфейс заблокирован!');
    };

    // ⬇️ Добавляем кнопку в модалку (вот этого не хватало!)
    modal.appendChild(hawkBtn);

    document.body.appendChild(modal);

    const rect = modal.getBoundingClientRect();
    modal.style.left = `calc(50% - ${rect.width / 2}px)`;
    modal.style.top = `calc(50% - ${rect.height / 2}px)`;

    requestAnimationFrame(() => {
        modal.style.opacity = '1';
    });

    currentModal = modal;
    outsideClickHandler = (e) => {
        if (!modal.contains(e.target)) removeActionModal();
    };
    setTimeout(() => document.addEventListener('click', outsideClickHandler), 0);
}

function removeActionModal() {
    if (currentModal) currentModal.remove();
    currentModal = null;
    if (outsideClickHandler) document.removeEventListener('click', outsideClickHandler);
    outsideClickHandler = null;
}

/* =================== История расходов =================== */
function showHistory() {
    const history = JSON.parse(localStorage.getItem('expensesHistory')) || [];
    const sortedHistory = history.sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));

    // Показываем оверлей
    overlay.style.display = 'block';

    // Создаём модалку
    const modal = document.createElement('div');
    modal.className = 'history-modal';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    const headerRow = document.createElement('tr');
    ['Банк', 'Дата', 'День недели', 'Сумма', 'Категория'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    sortedHistory.forEach(exp => {
        const row = document.createElement('tr');
        [exp.bank, exp.dateStr, exp.dayOfWeek, `${exp.amount.toFixed(2)} ₽`, exp.category].forEach(text => {
            const td = document.createElement('td');
            td.textContent = text;
            row.appendChild(td);
        });
        tbody.appendChild(row);
    });

    table.appendChild(thead);
    table.appendChild(tbody);

    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Закрыть';
    closeBtn.onclick = () => {
        overlay.style.display = 'none';
        modal.remove();
    };

    modal.appendChild(table);
    modal.appendChild(closeBtn);
    document.body.appendChild(modal);

    // Закрытие по клику на оверлей
    const overlayHandler = () => {
        overlay.style.display = 'none';
        modal.remove();
        overlay.removeEventListener('click', overlayHandler);
    };
    overlay.addEventListener('click', overlayHandler);
}

function cleanOldExpenses() {
    const history = JSON.parse(localStorage.getItem('expensesHistory')) || [];
    const twelveMonthsAgo = new Date();
    twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
    const recent = history.filter(exp => new Date(exp.dateISO) >= twelveMonthsAgo);
    localStorage.setItem('expensesHistory', JSON.stringify(recent));
}

/* =================== Переименование =================== */
function showRenameField(button, index) {
    const existing = button.parentNode.querySelector('.rename-container');
    if (existing) existing.remove();

    const container = document.createElement('div');
    container.className = 'rename-container';

    const input = document.createElement('input');
    const currentName = JSON.parse(localStorage.getItem('categories'))[index].name;
    input.type = 'text';
    input.value = currentName.length > 15 ? currentName.slice(0,15) : currentName;
    input.maxLength = 15;

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Сохранить';
    saveBtn.onclick = () => {
        let newName = input.value.trim();
        if (newName.length > 15) newName = newName.slice(0,15);
        if (newName) {
            updateCategory(index, newName);
            renderCategories();
        }
    };

    container.appendChild(input);
    container.appendChild(saveBtn);

    button.parentNode.insertBefore(container, button.nextSibling);
}

// Возвращает понедельник текущей недели
function getStartOfWeek() {
    const now = new Date();
    const day = now.getDay(); // 0 = вс, 1 = пн
    const diff = now.getDate() - day + (day === 0 ? -6 : 1); // смещаем к понедельнику
    const monday = new Date(now.setDate(diff));
    monday.setHours(0,0,0,0);
    return monday;
}

// Считает сумму расходов за текущую неделю
function calculateWeeklyExpenses() {
    const categories = JSON.parse(localStorage.getItem('categories')) || [];
    const startOfWeek = getStartOfWeek();
    let weeklyTotal = 0;

    categories.forEach(c => {
        // проверяем, что категория включена через тумблер
        if (c.limitEnabled && c.lastUpdate) {
            const updateDate = new Date(c.lastUpdate);
            if (updateDate >= startOfWeek) {
                weeklyTotal += c.amount;
            }
        }
    });

    // Сохраняем в localStorage
    localStorage.setItem('weeklyTotal', weeklyTotal.toString());

    const weeklyElem = document.getElementById('weeklyExpenses');
    if (weeklyElem) {
        weeklyElem.textContent = `Еженедельные расходы: ${weeklyTotal.toFixed(2)} ₽`;
    }
}

/* =================== Загрузка =================== */
document.addEventListener('DOMContentLoaded', () => {
    if (!localStorage.getItem('weeklyTotal')) {
        localStorage.setItem('weeklyTotal', '0');
    }

    cleanOldExpenses(); // Очищаем старые записи
    autoResetMonthlyExpenses();
    autoResetWeeklyExpenses();
    initCards(); // Инициализируем карты
    showSection('expenses');
    renderCategories();

    // Восстанавливаем последнюю выбранную карту
    const savedBank = localStorage.getItem('selectedBank');
    if (savedBank && cards.length > 0) {
        // Небольшая задержка, чтобы убедиться, что карты инициализированы
        setTimeout(() => {
            moveCardToTop(savedBank);
        }, 100);
    }
});

/* ================== Эффект искр ================== */
const canvas = document.getElementById('sparkCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener('scroll', () => {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const docHeight = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight) - window.innerHeight;
    const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
    
    const maxHeight = window.innerHeight * 0.4; // плашка растёт до чуть выше середины экрана
    const scrollBar = document.getElementById('scrollBar');
    if(scrollBar) {
        scrollBar.style.top = '0'; 
        scrollBar.style.height = `${scrollPercent * maxHeight}px`;
    }
});

let particles = [];
class Particle {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.size = Math.random() * 2 + 2;
        this.speedX = (Math.random() - 0.5) * 2;
        this.speedY = Math.random() * -2 - 1;
        this.alpha = 1;
        const hue = Math.random() * 30 + 20;
        this.color = `hsl(${hue}, 100%, 50%)`;
    }
    update() {
        this.x += this.speedX;
        this.y += this.speedY;
        this.alpha -= 0.02;
        this.size *= 0.95;
    }
    draw() {
        ctx.globalAlpha = this.alpha;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, this.size, this.size * 0.3, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

const header = document.querySelector('header');
header.addEventListener('pointermove', e => {
    for (let i = 0; i < 3; i++) particles.push(new Particle(e.clientX, e.clientY));
});

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach((p, i) => {
        p.update();
        p.draw();
        if (p.alpha <= 0) particles.splice(i, 1);
    });
    requestAnimationFrame(animateParticles);
}
animateParticles();

function toggleSubmenu() {
    const submenu = document.getElementById('settingsSubmenu');
    const adminSubmenu = document.getElementById('adminSubmenu');

    if (submenu.style.display === 'block') {
        submenu.style.display = 'none';
    } else {
        submenu.style.display = 'block';
        if (adminSubmenu) adminSubmenu.style.display = 'none';
    }
}

function toggleAdminSubmenu() {
    const adminSubmenu = document.getElementById('adminSubmenu');
    const submenu = document.getElementById('settingsSubmenu');

    if (adminSubmenu.style.display === 'block') {
        adminSubmenu.style.display = 'none';
    } else {
        adminSubmenu.style.display = 'block';
        if (submenu) submenu.style.display = 'none';
    }
}

function clearLimits() {
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    categories.forEach(c => c.limit = 0);
    localStorage.setItem('categories', JSON.stringify(categories));
    alert("Все лимиты удалены");
    renderCategories();
}

function clearExpenses() {
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    categories.forEach(c => c.amount = 0);
    localStorage.setItem('categories', JSON.stringify(categories));
    alert("Все расходы удалены");
    renderCategories();
}

// === Часы и дата в правом верхнем углу ===
function updateClock() {
    const now = new Date();

    // День недели
    const days = ['Воскресенье','Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];
    const weekday = days[now.getDay()];

    // Дата
    const dateStr = now.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });

    // Время
    const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    // Вывод
    document.getElementById('clock').textContent = `${weekday}, ${dateStr} ${timeStr}`;
}

// Обновляем каждую секунду
setInterval(updateClock, 1000);
updateClock();

// === Автоматический сброс расходов в начале месяца ===
function autoResetMonthlyExpenses() {
    const today = new Date();
    const currentMonth = today.getMonth(); // 0 = январь, 11 = декабрь
    const currentYear = today.getFullYear();

    // Проверяем, когда последний раз сбрасывали
    const lastReset = JSON.parse(localStorage.getItem('lastResetMonth'));

    // Если сегодня 1-е число и месяц+год другой — делаем сброс
    if (today.getDate() === 1 && (!lastReset || lastReset.month !== currentMonth || lastReset.year !== currentYear)) {
        let categories = JSON.parse(localStorage.getItem('categories')) || [];

        // Обнуляем траты
        categories.forEach(c => c.amount = 0);
        localStorage.setItem('categories', JSON.stringify(categories));

        // Запоминаем месяц и год последнего сброса
        localStorage.setItem('lastResetMonth', JSON.stringify({month: currentMonth, year: currentYear}));

        alert("Новый месяц! Все расходы обнулены.");
        renderCategories(); // обновляем интерфейс
    }
}

// === Автоматический сброс еженедельных расходов каждый понедельник ===
function autoResetWeeklyExpenses() {
    const today = new Date();
    const day = today.getDay(); // 0 = вс, 1 = пн

    if (day === 1) { // понедельник
        const mondayDateStr = today.toISOString().slice(0,10); // yyyy-mm-dd
        const lastWeeklyReset = localStorage.getItem('lastWeeklyReset');

        if (lastWeeklyReset !== mondayDateStr) {
            // Обнуляем только weeklyTotal
            localStorage.setItem('weeklyTotal', '0');
            localStorage.setItem('lastWeeklyReset', mondayDateStr);

            calculateWeeklyExpenses(); // обновляем интерфейс
        }
    }
}
// Эффект зелёной плашки при прокрутке
window.addEventListener('scroll', () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
    const maxHeight = 50; // высота плашки в пикселях
    const scrollBar = document.getElementById('scrollBar');
    if(scrollBar) scrollBar.style.height = `${scrollPercent * maxHeight}px`;
});

// Глобальная функция moveCardToTop (для вызова из DOMContentLoaded)
function moveCardToTop(bankName) {
    if (cards.length === 0) return;
    const card = cards.find(c => c.dataset.bank === bankName);
    if (!card) return;
    
    stack.appendChild(card);
    cards = [...cards.filter(c => c !== card), card];
    localStorage.setItem('selectedBank', bankName);
    // Переинициализируем слушатели
    const getCards = () => Array.from(stack.querySelectorAll('.card'));
    getCards().forEach(card => {
        card.removeEventListener('click', handleCardClick);
        card.addEventListener('click', handleCardClick);
    });

    function handleCardClick(e) {
        if (!stack.classList.contains('expanded')) return;
        e.stopPropagation();
        moveCardToTop(this.dataset.bank);
        stack.classList.remove('expanded');
        overlay.style.display = 'none';
    }
}

</script>

</div>

</body>
</html>
```​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​
