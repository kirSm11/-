<script>
let cards = [];
const stack = document.getElementById('cardStack');
const overlay = document.getElementById('overlay');
const cardStack = document.getElementById('cardStack');
let chartInstance = null;

function initCards() {
  if (!stack || !overlay) {
    console.error('Элементы stack или overlay не найдены');
    return;
  }
  const getCards = () => Array.from(stack.querySelectorAll('.card'));
  cards = getCards();

  function moveCardToTop(bankName) {
    if (cards.length === 0) return;
    const card = cards.find(c => c.dataset.bank === bankName);
    if (!card) return;
    stack.prepend(card);
    cards = [card, ...cards.filter(c => c !== card)];
    localStorage.setItem('selectedBank', bankName);
    if (!stack.classList.contains('expanded')) {
      updateCardStyles();
    }
    initCardListeners();
  }

  function updateCardStyles() {
    cards.forEach((card, index) => {
      card.style.zIndex = cards.length - index;
      card.style.transform = `translate(0, ${-index * 5}px) rotate(0deg)`;
    });
  }

  function toggleStack() {
    stack.classList.toggle('expanded');
    overlay.style.display = stack.classList.contains('expanded') ? 'block' : 'none';
    if (!stack.classList.contains('expanded')) {
      updateCardStyles();
    } else {
      cards.forEach(card => {
        card.style.transform = '';
        card.style.zIndex = '';
      });
    }
  }

  stack.addEventListener('click', e => {
    if (e.target.closest('button')) return;
    toggleStack();
  });

  overlay.addEventListener('click', () => {
    stack.classList.remove('expanded');
    overlay.style.display = 'none';
    updateCardStyles();
  });

  stack.querySelectorAll('.bank-buttons button').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const bankName = btn.dataset.bank || btn.textContent.trim();
      moveCardToTop(bankName);
      stack.classList.remove('expanded');
      overlay.style.display = 'none';
      updateCardStyles();
    });
  });

  function initCardListeners() {
    getCards().forEach(card => {
      card.removeEventListener('click', handleCardClick);
      card.addEventListener('click', handleCardClick);
    });
  }

  function handleCardClick(e) {
    if (!stack.classList.contains('expanded')) return;
    e.stopPropagation();
    const bankName = this.dataset.bank;
    moveCardToTop(bankName);
    stack.classList.remove('expanded');
    overlay.style.display = 'none';
    updateCardStyles();
  }

  initCardListeners();
  updateCardStyles();
  const savedBank = localStorage.getItem('selectedBank');
  if (savedBank) {
    setTimeout(() => moveCardToTop(savedBank), 100);
  }
}

function spring(element) {
  element.classList.add('springing');
  element.addEventListener('animationend', () => {
    element.classList.remove('springing');
  }, { once: true });
}

function showSection(id) {
  const sections = document.querySelectorAll('main section');
  sections.forEach(sec => sec.style.display = 'none');
  const targetSection = document.getElementById(id);
  if (targetSection) {
    targetSection.style.display = 'block';
  } else {
    console.warn(`Секция с id "${id}" не найдена`);
  }
  if (id === 'expenses') {
    cardStack.style.display = 'block';
    renderCategories();
    calculateWeeklyExpenses();
  } else {
    cardStack.style.display = 'none';
    if (cardStack.classList.contains('expanded')) {
      cardStack.classList.remove('expanded');
      overlay.style.display = 'none';
      updateCardStyles();
    }
  }
  if (id === 'stats') {
    renderStats();
  }
  if (id === 'settings') {
    renderSettings();
  }
}

function addCategory(button) {
  spring(button);
  const container = document.getElementById('newCategoryContainer');
  if (!container) return;
  container.innerHTML = `
    <input type="text" id="newCategoryName" placeholder="Название категории">
    <button onclick="saveCategory(this)">Сохранить</button>
  `;
}

function saveCategory(button) {
  spring(button);
  const input = document.getElementById('newCategoryName');
  if (!input) return;
  const name = input.value.trim();
  if (name) {
    const categories = JSON.parse(localStorage.getItem('categories')) || [];
    categories.push({ name, limit: 0, limitEnabled: false });
    localStorage.setItem('categories', JSON.stringify(categories));
    document.getElementById('newCategoryContainer').innerHTML = '';
    renderCategories();
    renderSettings();
  }
}

function renderCategories() {
  const list = document.getElementById('categoriesList');
  if (!list) return;
  list.innerHTML = '';
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  categories.forEach((cat, index) => {
    const button = document.createElement('button');
    button.textContent = cat.name;
    button.dataset.index = index;
    button.addEventListener('click', e => showActionModal(e, cat.name, index));
    button.addEventListener('touchstart', e => startDrag(e, index));
    button.addEventListener('dragstart', e => startDrag(e, index));
    list.appendChild(button);
  });
  addDragPlaceholders();
  calculateWeeklyExpenses();
}

function addDragPlaceholders() {
  const list = document.getElementById('categoriesList');
  if (!list) return;
  const placeholders = document.querySelectorAll('.placeholder');
  placeholders.forEach(p => p.remove());
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  categories.forEach((_, index) => {
    const placeholder = document.createElement('div');
    placeholder.className = 'placeholder';
    placeholder.dataset.index = index;
    placeholder.addEventListener('dragover', e => e.preventDefault());
    placeholder.addEventListener('drop', e => drop(e, index));
    list.insertBefore(placeholder, list.children[index]);
  });
}

function startDrag(e, index) {
  e.dataTransfer?.setData('text/plain', index);
  const button = e.target;
  button.classList.add('dragging');
  setTimeout(() => {
    button.style.display = 'none';
  }, 0);
}

function drop(e, targetIndex) {
  e.preventDefault();
  const sourceIndex = e.dataTransfer?.getData('text/plain');
  const button = document.querySelector('.dragging');
  if (button) {
    button.style.display = 'block';
    button.classList.remove('dragging');
  }
  if (sourceIndex !== undefined) {
    const categories = JSON.parse(localStorage.getItem('categories')) || [];
    const [moved] = categories.splice(sourceIndex, 1);
    categories.splice(targetIndex, 0, moved);
    localStorage.setItem('categories', JSON.stringify(categories));
    renderCategories();
  }
}

function showActionModal(e, category, index) {
  e.stopPropagation();
  const modal = document.createElement('div');
  modal.className = 'action-modal';
  modal.style.left = `${e.clientX}px`;
  modal.style.top = `${e.clientY}px`;
  modal.innerHTML = `
    <button onclick="addExpense(this, '${category}', ${index})">Добавить расход</button>
    <button class="rename" onclick="renameCategory(this, '${category}', ${index})">Переименовать</button>
    <button onclick="deleteCategory(this, ${index})">Удалить</button>
    <button onclick="showHistory(this, '${category}')">История</button>
  `;
  document.body.appendChild(modal);
  setTimeout(() => {
    document.addEventListener('click', () => modal.remove(), { once: true });
  }, 0);
}

function addExpense(button, category, index) {
  spring(button);
  const modal = button.closest('.action-modal');
  if (!modal) return;
  modal.innerHTML = `
    <input type="number" id="expenseAmount" placeholder="Сумма">
    <input type="date" id="expenseDate">
    <button onclick="saveExpense(this, '${category}', ${index})">Сохранить</button>
  `;
}

function saveExpense(button, category, index) {
  spring(button);
  const amountInput = document.getElementById('expenseAmount');
  const dateInput = document.getElementById('expenseDate');
  if (!amountInput || !dateInput) return;
  const amount = parseFloat(amountInput.value);
  const date = dateInput.value || new Date().toISOString().split('T')[0];
  if (amount && !isNaN(amount)) {
    const history = JSON.parse(localStorage.getItem('expenseHistory')) || [];
    const selectedBank = localStorage.getItem('selectedBank') || 'Другие';
    history.push({
      category,
      amount,
      date,
      dateISO: new Date(date).toISOString(),
      bank: selectedBank
    });
    localStorage.setItem('expenseHistory', JSON.stringify(history));
    button.closest('.action-modal').remove();
    calculateWeeklyExpenses();
    renderStats();
  }
}

function renameCategory(button, category, index) {
  spring(button);
  const modal = button.closest('.action-modal');
  if (!modal) return;
  modal.innerHTML = `
    <div class="rename-container">
      <input type="text" id="renameInput" value="${category}">
      <button onclick="saveRename(this, ${index})">Сохранить</button>
    </div>
  `;
}

function saveRename(button, index) {
  spring(button);
  const input = document.getElementById('renameInput');
  if (!input) return;
  const newName = input.value.trim();
  if (newName) {
    const categories = JSON.parse(localStorage.getItem('categories')) || [];
    const oldName = categories[index].name;
    categories[index].name = newName;
    localStorage.setItem('categories', JSON.stringify(categories));
    const history = JSON.parse(localStorage.getItem('expenseHistory')) || [];
    history.forEach(exp => {
      if (exp.category === oldName) {
        exp.category = newName;
      }
    });
    localStorage.setItem('expenseHistory', JSON.stringify(history));
    button.closest('.action-modal').remove();
    renderCategories();
    renderSettings();
  }
}

function deleteCategory(button, index) {
  spring(button);
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  const categoryName = categories[index].name;
  categories.splice(index, 1);
  localStorage.setItem('categories', JSON.stringify(categories));
  const history = JSON.parse(localStorage.getItem('expenseHistory')) || [];
  const updatedHistory = history.filter(exp => exp.category !== categoryName);
  localStorage.setItem('expenseHistory', JSON.stringify(updatedHistory));
  button.closest('.action-modal').remove();
  renderCategories();
  renderSettings();
  calculateWeeklyExpenses();
  renderStats();
}

function showHistory(button, category) {
  spring(button);
  const modal = document.createElement('div');
  modal.className = 'history-modal';
  const history = JSON.parse(localStorage.getItem('expenseHistory')) || [];
  const filteredHistory = history.filter(exp => exp.category === category);
  const banks = ['Сбер', 'Яндекс', 'Тинькофф', 'Альфа', 'ВТБ', 'Халва', 'Уралсиб', 'Другие'];

  let tableHTML = `
    <div class="history-filter">
      <select id="bankFilter" onchange="updateHistoryTable('${category}')">
        <option value="">Все банки</option>
        ${banks.map(bank => `<option value="${bank}">${bank}</option>`).join('')}
      </select>
    </div>
    <table>
      <thead>
        <tr>
          <th>Сумма</th>
          <th>Дата</th>
          <th>Банк</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
      </tbody>
    </table>
    <button onclick="this.closest('.history-modal').remove()">Закрыть</button>
    <button class="close-btn" onclick="this.closest('.history-modal').remove()"></button>
  `;
  modal.innerHTML = tableHTML;
  document.body.appendChild(modal);
  updateHistoryTable(category);
  button.closest('.action-modal').remove();
}

function updateHistoryTable(category) {
  const history = JSON.parse(localStorage.getItem('expenseHistory')) || [];
  const bankFilter = document.getElementById('bankFilter')?.value || '';
  let filteredHistory = history.filter(exp => exp.category === category);
  if (bankFilter) {
    filteredHistory = filteredHistory.filter(exp => exp.bank === bankFilter);
  }
  const tbody = document.getElementById('historyTableBody');
  if (!tbody) return;
  tbody.innerHTML = filteredHistory.map(exp => `
    <tr>
      <td>${exp.amount.toFixed(2)} ₽</td>
      <td>${exp.date}</td>
      <td>${exp.bank}</td>
    </tr>
  `).join('');
}

function getFilteredHistory() {
  const history = JSON.parse(localStorage.getItem('expenseHistory')) || [];
  const bankFilter = localStorage.getItem('selectedBank') || 'Другие';
  return history.filter(exp => exp.bank === bankFilter);
}

function getStartOfWeek() {
  const now = new Date();
  const day = now.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  const start = new Date(now);
  start.setDate(now.getDate() + diff);
  start.setHours(0, 0, 0, 0);
  return start;
}

function calculateWeeklyExpenses() {
  const filteredHistory = getFilteredHistory();
  const startOfWeek = getStartOfWeek();
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  let weeklyTotal = 0;

  filteredHistory.forEach(exp => {
    const updateDate = new Date(exp.dateISO);
    const category = categories.find(cat => cat.name === exp.category);
    if (updateDate >= startOfWeek && category && category.limitEnabled) {
      weeklyTotal += exp.amount;
    }
  });

  localStorage.setItem('weeklyTotal', weeklyTotal.toString());
  const weeklyElem = document.getElementById('weeklyExpenses');
  if (weeklyElem) {
    weeklyElem.textContent = `Еженедельные расходы: ${weeklyTotal.toFixed(2)} ₽`;
  }
}

function renderStats() {
  const statsCategories = document.getElementById('statsCategories');
  const totalsContainer = document.getElementById('totalsContainer');
  if (!statsCategories || !totalsContainer) return;
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  const history = JSON.parse(localStorage.getItem('expenseHistory')) || [];
  const bankFilter = localStorage.getItem('selectedBank') || 'Другие';
  const filteredHistory = history.filter(exp => exp.bank === bankFilter);

  statsCategories.innerHTML = '';
  const categoryTotals = {};
  categories.forEach(cat => {
    categoryTotals[cat.name] = 0;
  });
  filteredHistory.forEach(exp => {
    if (categoryTotals.hasOwnProperty(exp.category)) {
      categoryTotals[exp.category] += exp.amount;
    }
  });
  categories.forEach(cat => {
    const div = document.createElement('div');
    div.className = 'stat-item';
    div.innerHTML = `
      ${cat.name}: ${categoryTotals[cat.name].toFixed(2)} ₽
      <button onclick="showHistory(this, '${cat.name}')">История</button>
    `;
    statsCategories.appendChild(div);
  });

  let totalExpenses = 0;
  filteredHistory.forEach(exp => {
    totalExpenses += exp.amount;
  });
  totalsContainer.innerHTML = `
    <h3>Итого</h3>
    <p>Общие расходы: ${totalExpenses.toFixed(2)} ₽</p>
    <p>Еженедельные расходы: ${(parseFloat(localStorage.getItem('weeklyTotal')) || 0).toFixed(2)} ₽</p>
  `;

  if (chartInstance) {
    chartInstance.destroy();
  }
  const ctx = document.getElementById('statsChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: categories.map(cat => cat.name),
      datasets: [{
        data: categories.map(cat => categoryTotals[cat.name] || 0),
        backgroundColor: [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top'
        }
      }
    }
  });
}

function renderSettings() {
  const settingsSubmenu = document.getElementById('settingsSubmenu');
  const settingsCategories = document.getElementById('settingsCategories');
  if (!settingsSubmenu || !settingsCategories) return;
  settingsSubmenu.style.display = 'block';
  settingsCategories.innerHTML = '';
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  categories.forEach((cat, index) => {
    const div = document.createElement('div');
    div.className = 'settings-row';
    div.innerHTML = `
      <span class="name">${cat.name}</span>
      <span class="limit-badge ${cat.limitEnabled ? 'active' : ''}" onclick="editLimit(this, ${index})">${cat.limit ? cat.limit.toFixed(2) : '0.00'} ₽</span>
      <label class="switch">
        <input type="checkbox" ${cat.limitEnabled ? 'checked' : ''} onchange="toggleLimit(this, ${index})">
        <span class="slider"></span>
      </label>
    `;
    settingsCategories.appendChild(div);
  });
}

function editLimit(badge, index) {
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  const currentLimit = categories[index].limit || 0;
  const newLimit = prompt('Введите лимит для категории:', currentLimit);
  if (newLimit !== null && !isNaN(newLimit) && newLimit >= 0) {
    categories[index].limit = parseFloat(newLimit);
    localStorage.setItem('categories', JSON.stringify(categories));
    renderSettings();
  }
}

function toggleLimit(checkbox, index) {
  const categories = JSON.parse(localStorage.getItem('categories')) || [];
  categories[index].limitEnabled = checkbox.checked;
  localStorage.setItem('categories', JSON.stringify(categories));
  renderSettings();
  calculateWeeklyExpenses();
}

function createSparkEffect(x, y) {
  const canvas = document.getElementById('sparkCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const particles = [];
  for (let i = 0; i < 50; i++) {
    particles.push({
      x: x,
      y: y,
      size: Math.random() * 5 + 2,
      speedX: Math.random() * 6 - 3,
      speedY: Math.random() * 6 - 3,
      life: Math.random() * 20 + 20
    });
  }
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      p.x += p.speedX;
      p.y += p.speedY;
      p.life--;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 215, 0, ${p.life / 50})`;
      ctx.fill();
    });
    const activeParticles = particles.filter(p => p.life > 0);
    if (activeParticles.length > 0) {
      requestAnimationFrame(animate);
    } else {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  }
  animate();
}

function updateCardStyles() {
  cards.forEach((card, index) => {
    card.style.zIndex = cards.length - index;
    card.style.transform = `translate(0, ${-index * 5}px) rotate(0deg)`;
  });
}

window.addEventListener('load', () => {
  initCards();
  showSection('expenses');
});

window.addEventListener('resize', () => {
  const canvas = document.getElementById('sparkCanvas');
  if (canvas) {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
});

window.addEventListener('scroll', () => {
  const scrollBar = document.getElementById('scrollBar');
  if (!scrollBar) return;
  const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
  const scrollPosition = window.scrollY;
  const scrollPercentage = Math.min(scrollPosition / maxScroll, 1);
  scrollBar.style.height = `${scrollPercentage * 50}px`;
});
</script>
